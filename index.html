<script>
    // Global state variables
    let selectedPlayerHand = null;
    let selectedDealerCard = null;

    /**
     * Toggles the visibility of different sections of the app.
     * @param {string} sectionId The ID of the section to show.
     */
    function showSection(sectionId) {
        // Clear highlights and selections when switching screens
        selectedPlayerHand = null;
        selectedDealerCard = null;
        updateHighlight();

        const sections = document.querySelectorAll('.container > div');
        sections.forEach(section => {
            if (section.id === sectionId) {
                section.classList.remove('hidden');
                section.classList.add('animate-fadeIn');
            } else {
                section.classList.add('hidden');
                section.classList.remove('animate-fadeIn');
            }
        });
    }

    /**
     * Navigates back to the main screen.
     */
    function goBack() {
        showSection('main-screen');
    }

    /**
     * Updates the highlighting based on the selected player hand and dealer card.
     */
    function updateHighlight() {
        const tables = document.querySelectorAll('table');

        tables.forEach(table => {
            // Clear all previous highlights
            const allCells = table.querySelectorAll('td, th');
            allCells.forEach(cell => {
                cell.classList.remove('highlighted-row-header', 'highlighted-col-header', 'highlighted-cell', 'highlighted-pd', 'highlighted-intersection');
            });

            // Apply new highlights for player hand if selected
            if (selectedPlayerHand) {
                const playerHeaders = table.querySelectorAll(`[data-hand="${selectedPlayerHand}"]`);
                playerHeaders.forEach(header => {
                    header.classList.add('highlighted-row-header');
                });
            }
            
            // Apply new highlights for dealer card if selected
            if (selectedDealerCard) {
                const dealerHeader = table.querySelector(`thead th[data-dealer="${selectedDealerCard}"]`);
                if (dealerHeader) {
                    dealerHeader.classList.add('highlighted-col-header');
                    const dealerIndex = Array.from(dealerHeader.parentNode.children).indexOf(dealerHeader);
                    table.querySelectorAll('tr').forEach(row => {
                        const cell = row.children[dealerIndex];
                        if (cell && cell.tagName === 'TD') {
                            cell.classList.add('highlighted-col-header');
                        }
                    });
                }
            }

            // Highlight the intersection cell if both are selected
            if (selectedPlayerHand && selectedDealerCard) {
                const intersectionCell = table.querySelector(`td[data-hand="${selectedPlayerHand}"][data-dealer="${selectedDealerCard}"]`);
                if (intersectionCell) {
                    intersectionCell.classList.add('highlighted-intersection');
                    // Remove ALL other highlights from the intersection cell
                    intersectionCell.classList.remove('highlighted-row-header', 'highlighted-col-header', 'highlighted-cell');
                }
            }
        });
    }

    /**
     * Initializes all event listeners for the tables.
     */
    function initializeTableListeners() {
        // Get all tables and add a single click listener to each
        const tables = document.querySelectorAll('table');

        tables.forEach(table => {
            // Add event listener to player hand cells (first column)
            const playerHandHeaders = table.querySelectorAll('tbody td[data-hand]');
            playerHandHeaders.forEach(cell => {
                cell.onclick = (event) => {
                    const currentHand = event.target.dataset.hand;
                    if (selectedPlayerHand === currentHand) {
                        // Deselect if already selected
                        selectedPlayerHand = null;
                    } else {
                        selectedPlayerHand = currentHand;
                    }
                    updateHighlight();
                };
            });

            // Add event listener to dealer card headers (top row)
            const dealerHeaders = table.querySelectorAll('thead th[data-dealer]');
            dealerHeaders.forEach(cell => {
                cell.onclick = (event) => {
                    const currentDealer = event.target.dataset.dealer;
                    if (selectedDealerCard === currentDealer) {
                        // Deselect if already selected
                        selectedDealerCard = null;
                    } else {
                        selectedDealerCard = currentDealer;
                    }
                    updateHighlight();
                };
            });

            // Add event listener to action cells for dual highlighting
            const actionCells = table.querySelectorAll('tbody td[data-hand][data-dealer]');
            actionCells.forEach(cell => {
                cell.onclick = (event) => {
                    const targetHand = event.target.dataset.hand;
                    const targetDealer = event.target.dataset.dealer;

                    // Toggle selection for both hand and dealer card
                    if (selectedPlayerHand === targetHand && selectedDealerCard === targetDealer) {
                        selectedPlayerHand = null;
                        selectedDealerCard = null;
                    } else {
                        selectedPlayerHand = targetHand;
                        selectedDealerCard = targetDealer;
                    }
                    
                    updateHighlight();
                };
            });
        });
    }

    // Set up the app on page load
    window.onload = function() {
        // Initially show the main menu
        showSection('main-screen');
        // Initialize all event listeners
        initializeTableListeners();
    };
</script>
